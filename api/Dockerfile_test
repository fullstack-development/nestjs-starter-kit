FROM node:16.17-alpine3.15

COPY . /stk
WORKDIR /stk

ENV DB_ADDRESS=$DB_ADDRESS
ENV DB_USER=$DB_USER
ENV DB_PASSWORD=$DB_PASSWORD
ENV DB_NAME=$DB_NAME 
ENV DB_PORT=$DB_PORT
ENV JWT_SECRET=$JWT_SECRET
ENV JWT_EXPIRES_IN=$JWT_EXPIRES_IN 
ENV PORT_API=$PORT_API 
ENV JWT_REFRESH_TOKEN_SECRET=$JWT_REFRESH_TOKEN_SECRET 
ENV JWT_REFRESH_TOKEN_EXPIRATION_TIME=$JWT_REFRESH_TOKEN_EXPIRATION_TIME
ENV AUTH_CODE_EXPIRES_IN_MINUTES=$AUTH_CODE_EXPIRES_IN_MINUTES
ENV FULL_PRODUCTION_MODE=$FULL_PRODUCTION_MODE
ENV BLOCKPASS_SECRET_KEY=$BLOCKPASS_SECRET_KEY
ENV BLOCKPASS_CLIENT_ID=$BLOCKPASS_CLIENT_ID
ENV WORKER_HOST=$WORKER_HOST

RUN yarn
RUN yarn build

EXPOSE 3000

CMD ["sh", "-c", "sleep 2 && DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_ADDRESS}:5432/${DB_NAME} yarn prisma:migrate:dev && WORKER_HOST=$WORKER_HOST BLOCKPASS_CLIENT_ID=$BLOCKPASS_CLIENT_ID BLOCKPASS_SECRET_KEY=$BLOCKPASS_SECRET_KEY FULL_PRODUCTION_MODE=$FULL_PRODUCTION_MODE AUTH_CODE_EXPIRES_IN_MINUTES=$AUTH_CODE_EXPIRES_IN_MINUTES DB_ADDRESS=$DB_ADDRESS DB_USER=$DB_USER DB_PASSWORD=$DB_PASSWORD DB_NAME=$DB_NAME DB_PORT=$DB_PORT JWT_SECRET=$JWT_SECRET JWT_EXPIRES_IN=$JWT_EXPIRES_IN PORT_API=$PORT_API JWT_REFRESH_TOKEN_SECRET=$JWT_REFRESH_TOKEN_SECRET JWT_REFRESH_TOKEN_EXPIRATION_TIME=$JWT_REFRESH_TOKEN_EXPIRATION_TIME yarn start:prod"]
